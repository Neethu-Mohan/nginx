sudo: required
addons:
  apt:
    update: true
    packages:
    - docker-ce
services:
- docker
script:
- export DOCKER_CLI_EXPERIMENTAL=enabled
- source sha_function.sh
- flag_alpine=$(is_base "treehouses/alpine:latest" "treehouses/nginx:latest")
- echo $flag_alpine
- version2=$(image_version treehouses/nginx:latest)
- echo "treehouses version is $version2"
- echo $DOCKERAPIKEY | docker login -u "sevenseas" --password-stdin
- docker run --rm --privileged multiarch/qemu-user-static --reset -p yes   # for arm64
- "./docker-build.sh treehouses/alpine:latest arm"    #Dockerfile base image is arm arch
- "./docker-build.sh treehouses/alpine:latest arm64"    #Dockerfile base image is arm64 arch
- "./docker-build.sh treehouses/alpine:latest amd64"    #Dockerfile base image is amd64 arch
- flag=$(compare "treehouses/alpine:latest" "treehouses/nginx:latest" "treehouses/nginx:latest" "treehouses/nginx-tags:amd64")
- echo $flag
before_deploy:
- timetag=$(date +%Y%m%d%H%M)
- echo $timetag
- tag1="latest"
- tag2=$timetag
- echo $tag2
- create_manifest treehouses/nginx $tag1 $tag2 treehouses/nginx-tags:amd64 treehouses/nginx-tags:arm treehouses/nginx-tags:arm64
- docker manifest inspect treehouses/nginx:$tag1
- docker manifest inspect treehouses/nginx:$tag2
deploy:
- provider: script
  script: docker manifest push treehouses/nginx:$tag1; docker manifest push treehouses/nginx:$tag2
  skip_cleanup: true
  on:
    all_branches: true
    condition: "$flag = true"
env:
  global:
  - secure: J8LSPFdzwosy/Ik4FZUGTjrv3cc4DZck5ZDlxlVvz2z15aYfPR6gyEf7bcFHCAU3shxuXsUZ/NygKwfB1aQZPjxdBiV0NCU0UQ5jJ6pQoWUxIBla//991n5r/1W5gELXB2CgBV4b7YR6sos5F7hTGZEEOAtR6KZkRwXSrdG9z2utX/s0bnZcmYbhHA7e3NOl2JMNRV5/bsF/isPN8sMSvASqJmYzgbCW3ozow372YLh4xQM2FecPKwvUi9I6bpC8CL8ShCMfJoLxKp0kohNab/PLNGHYDY9v2L/P1AcTxKkPHOyq94jOQVqKrTZMZZcm1rGlCMEkM5H1N8V0oHRlDU3uRvZdq5h/t5d3yHBuzB9Nvej6mSwMZtxxplvHteYjCHU27L2aRuWsbM/DxXo+LB5p0Ek6GbVVQaAJvhpFq5XsIsxdtJE/Ruldg/RWTRMxG8wvtNIakrzTsuoxjzeAHYCTmrVo8U4d8xl356rGHV4SFHjuXunykZXslvfoTJEMq4w6Z8zhYTWWQTxf9o9Lo7e1pMTOxPbqvyTs5Q69REat81Uz8NIxE/JgoioTMFD8praC6lAI6SZF6yOyYjMM3fYHHsReH2/gFu0YaI03IRg3HpVFu3Ok0iVSVGMEVmvKfY2TNb2EcuiaVCLVDhn9rczMqEuHLHP0x4v6e6xbJmY=
  - secure: HYZNwQY0Or9KLdZaLNmHtGoOIXh4FvakJ/M1UoIQU1Ihq0/Aw1J3dm1CdAtpQLG+JP8/3ZBUipdCm7Fg/UuLPZQXlL53XPwUczcdmM/H/lbeIEXkCLMqNVQ4VeyxZIkVRweT0n3hKpgLiGnq0dVGcRM530pzseh2MKoTh/iTFgcoaFBdh040nDADh2s0qfSvfruh01vweQdIEkDH4R3Xe43mo20Q+rtkXpQdufMXvzFIVP/9wgWKgI458//UxAqvEtNh5sDLPlmSfsNmZdzXv+7Ekxuy18opFlduF273mRKlrSd/yfGf3LdrggrHlXV4R9spk5Kd1KHfI//R5Do69tTTr5PFFZwOgMBm9umm47B1sc5tP7BqG4kxp5Fxk3jXNGnFnMtbEIH2a6qRJGg5/gh+jxVs1610ht52vxGdwRzfq1UAAlMLci3omt0fktNWu/xYymqv2yDErwlo6sody+LZr4aF5gZ3B8gaGFwaCqluFQzNF3h/v5pIiSi7Drh3ExXNHHedppVLQmZSdvLm1QwTjLxE1MqUXjzSvJU6QhmUtzKpMz+f0mY4tXuyIrDJA5LTPzlvDinKITSJ/rLIianG1P0SRwEOQzo3p5fmccMrV8EXsajCqWf5N5jwzBqiWX+zTmeoRhH3FEOnVCkinF3mPWpP6WKrIRyldt8x4AA=
  - secure: QDGtZWpbrrzktGhEXKf99VawpDFsdDbj/O+fmqFGAoQX64aMAUTfr30Z/HQIwS4VlTFY+QuqaC12mD5hPo078xSMfKHNx7PAsZKdfZXy5KRlXiZ3pP6ma99YC6GTIGU7ZgWEjsH5GBQk339ZsjgIC8df7MY17T2iP/BIeiWw0/joBd38OSBV2hrqqQLvordiwTDHaQ4fJ+nyobR1njo4pkOQU+cLRKgjBdChg/92fqgXUbt4orTUyQNR5BRt/vZyoBhNwCxDqVYvSIyT+0kgIjNOksTOplVM2cxbktUvM5+skjI9ZxVb1zFsGlqyCzFcTQfxRg1LVT/zWpl6a6Kf4DqqHhmZEgZnj4coVGwfr7IgZMQ2a79JyiK0I3YjrFulcFbln2UQ5gVCrAVSJOpOOo5P2xyp7ZfJ/6J95YM4Eyv3FCT3u+Gx7lyzQ8QmjnCkchn7G4zK5nZMd+KzcnBD6Ntfewoy6FXw7iZ/lFx16MlKblYjgfFAaHwapwFa3OUxo1HM70VFQLS8xvLrlnpJuPbwFQ4Wrlm18h8QQZesPy1pkZL3opPvC51HYKBkQvAUX/1GAaGt0EULhzFSad22aYSOV96FYcrb1dgAlvtMizgwZchH3txWZZiw5MvjTVaCYv6CI3b0Jy6AMYEbmQAEIC9mUCZiHMkhMEgV6Mk2zyA=
